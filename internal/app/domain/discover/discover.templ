package discover

import "fmt"
import "strings"
import "github.com/FACorreiaa/go-templui/internal/app/models"

templ DiscoverPage(recentDiscoveries []models.ChatSession, trending []models.TrendingDiscovery, featured []models.FeaturedCollection) {
	<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8 pb-16">
			<!-- Header -->
			<div class="mb-8">
				<div class="flex items-center gap-3 mb-6">
					<div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
						<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
						</svg>
					</div>
					<div>
						<h1 class="text-2xl font-bold text-foreground">Discover</h1>
						<p class="text-muted-foreground">Find amazing places and hidden gems</p>
					</div>
				</div>
				<!-- Enhanced Search Bar -->
				<div class="bg-card rounded-xl shadow-lg border p-6">
					<form
						hx-post="/discover/search"
						hx-target="#discover-results"
						hx-indicator="#search-loading"
					>
						<div class="flex flex-col md:flex-row gap-4">
							<div class="flex-1 relative">
								<input
									type="text"
									id="search-query"
									name="query"
									placeholder="What are you looking for? (e.g., 'best ramen in Tokyo', 'romantic restaurants Paris')"
									class="w-full pl-12 pr-4 py-3 rounded-lg border focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-background text-base"
								/>
								<svg class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
								</svg>
							</div>
							<div class="flex gap-2">
								<input
									type="text"
									name="location"
									placeholder="Location"
									class="px-4 py-3 rounded-lg border focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-background w-32 md:w-40"
								/>
								<button
									type="submit"
									class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all font-medium flex items-center justify-center"
								>
									<span class="htmx-request:hidden flex items-center gap-2">
										<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
										</svg>
										Search
									</span>
									<span id="search-loading" class="htmx-indicator inline-flex items-center">
										<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
										Searching...
									</span>
								</button>
							</div>
						</div>
					</form>
				</div>
			</div>
			<!-- Quick Categories - Now at top with smaller cards -->
			<div class="mb-10">
				<h2 class="text-base font-semibold text-foreground mb-3">Quick Categories</h2>
				<div class="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-12 gap-2">
					@CategoryCard("Restaurants", "ğŸ½ï¸", "restaurant")
					@CategoryCard("Hotels", "ğŸ¨", "hotel")
					@CategoryCard("Activities", "ğŸ¯", "activity")
					@CategoryCard("Attractions", "ğŸ›ï¸", "attraction")
					@CategoryCard("Nightlife", "ğŸŒƒ", "nightlife")
					@CategoryCard("Shopping", "ğŸ›ï¸", "shopping")
					@CategoryCard("Museums", "ğŸ¨", "museum")
					@CategoryCard("Parks", "ğŸŒ³", "park")
					@CategoryCard("Beaches", "ğŸ–ï¸", "beach")
					@CategoryCard("Adventure", "â›°ï¸", "adventure")
					@CategoryCard("Cultural", "ğŸ­", "cultural")
					@CategoryCard("Markets", "ğŸª", "market")
				</div>
			</div>
			<!-- Search Results Container - Now displayed first when results exist -->
			<div id="discover-results" class="mb-12"></div>
			<!-- Trending & Featured -->
			<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
				<!-- Trending Now -->
				<div class="lg:col-span-2">
					<h2 class="text-lg font-semibold text-foreground mb-4 flex items-center gap-2">
						<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
						</svg>
						Trending Now
					</h2>
					<div class="space-y-3">
						if len(trending) > 0 {
							for i, item := range trending {
								@TrendingItem(item.CityName, fmt.Sprintf("%d searches today", item.SearchCount), item.Emoji, i+1)
							}
						} else {
							<p class="text-sm text-muted-foreground">No trending discoveries yet today</p>
						}
					</div>
				</div>
				<!-- Featured Collections -->
				<div>
					<h2 class="text-lg font-semibold text-foreground mb-4 flex items-center gap-2">
						<svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
						</svg>
						Featured
					</h2>
					<div class="space-y-3">
						if len(featured) > 0 {
							for _, collection := range featured {
								@FeaturedItem(collection.Title, fmt.Sprintf("%d items", collection.ItemCount), collection.Emoji)
							}
						} else {
							<p class="text-sm text-muted-foreground">No featured collections available</p>
						}
					</div>
				</div>
			</div>
			<!-- Recent Discoveries (Dynamic Content) -->
			<div>
				<h2 class="text-lg font-semibold text-foreground mb-4">Recent Discoveries</h2>
				if len(recentDiscoveries) > 0 {
					<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
						for _, session := range recentDiscoveries {
							@RecentDiscoveryCard(session)
						}
					</div>
				} else {
					<div class="text-center py-12">
						<div class="text-4xl mb-4">ğŸ”</div>
						<p class="text-muted-foreground mb-2">No recent discoveries yet</p>
						<p class="text-sm text-muted-foreground">Start exploring to see your search history here</p>
					</div>
				}
			</div>
		</div>
	</div>
}

templ CategoryCard(name string, emoji string, category string) {
	<button
		type="button"
		onclick={ fillSearchInput(name) }
		class="p-2 bg-card rounded-lg border hover:shadow-md hover:border-blue-300 transition-all group text-center"
	>
		<div class="text-xl mb-1 group-hover:scale-110 transition-transform">{ emoji }</div>
		<p class="text-xs font-medium text-card-foreground">{ name }</p>
	</button>
}

script fillSearchInput(value string) {
	const input = document.getElementById('search-query');
	if (input) {
		input.value = value;
		input.focus();
	}
}

templ TrendingItem(title string, searches string, emoji string, rank int) {
	<div class="flex items-center gap-3 p-3 hover:bg-accent rounded-lg cursor-pointer transition-colors">
		<div class="flex items-center justify-center w-6 h-6 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-full text-xs font-bold">
			{ fmt.Sprintf("%d", rank) }
		</div>
		<span class="text-xl">{ emoji }</span>
		<div class="flex-1">
			<p class="font-medium text-card-foreground text-sm">{ title }</p>
			<p class="text-xs text-muted-foreground">{ searches }</p>
		</div>
		<svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
		</svg>
	</div>
}

templ FeaturedItem(title string, count string, emoji string) {
	<div class="flex items-center gap-3 p-3 hover:bg-accent rounded-lg cursor-pointer transition-colors">
		<span class="text-lg">{ emoji }</span>
		<div>
			<p class="font-medium text-card-foreground text-sm">{ title }</p>
			<p class="text-xs text-muted-foreground">{ count }</p>
		</div>
	</div>
}

templ DiscoveryCard(id string, category string, title string, location string, description string, emoji string, badge string, rating string) {
	<div class="bg-card rounded-xl shadow-sm border hover:shadow-md transition-shadow group cursor-pointer">
		<div class="p-6">
			<div class="flex items-start justify-between mb-4">
				<div class="flex items-center gap-3">
					<span class="text-3xl">{ emoji }</span>
					<div class="flex flex-col gap-1">
						<span
							class={ "inline-flex items-center px-2 py-1 rounded-full text-xs font-medium",
							templ.KV("bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300", category == "Restaurant"),
							templ.KV("bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300", category == "Activity"),
							templ.KV("bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300", category == "Hotel"),
							templ.KV("bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300", category == "Attraction") }
						>
							{ category }
						</span>
						if badge == "michelin" {
							<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300">
								Michelin â­
							</span>
						} else if badge == "luxury" {
							<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">
								Luxury ğŸ’
							</span>
						} else if badge == "adventure" {
							<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300">
								Adventure â›°ï¸
							</span>
						} else if badge == "natural" {
							<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300">
								Natural Wonder ğŸŒ¿
							</span>
						} else if badge == "nature" {
							<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-teal-100 text-teal-800 dark:bg-teal-900/30 dark:text-teal-300">
								Nature ğŸ¦‹
							</span>
						}
					</div>
				</div>
				<div class="flex items-center gap-1">
					<button
						hx-post={ "/favorites/add/" + id }
						hx-target="this"
						hx-swap="outerHTML"
						class="p-2 text-muted-foreground hover:text-red-500 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
						title="Add to favorites"
					>
						<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
						</svg>
					</button>
				</div>
			</div>
			<div class="space-y-3">
				<h3 class="font-semibold text-card-foreground group-hover:text-blue-600 transition-colors">
					{ title }
				</h3>
				<div class="flex items-center gap-2 text-sm text-muted-foreground">
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
					</svg>
					{ location }
				</div>
				<p class="text-muted-foreground text-sm">
					{ description }
				</p>
				<div class="flex items-center justify-between">
					<div class="flex items-center gap-1">
						<svg class="w-4 h-4 text-yellow-500 fill-current" fill="currentColor" viewBox="0 0 24 24">
							<path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
						</svg>
						<span class="text-sm font-medium">{ rating }</span>
					</div>
				</div>
			</div>
			<div class="flex items-center justify-between mt-4 pt-4 border-t border-border">
				<button class="text-blue-600 hover:text-blue-700 text-sm font-medium">
					Learn More
				</button>
				<div class="flex items-center gap-2">
					<button
						hx-post={ "/bookmarks/add/" + id }
						class="text-muted-foreground hover:text-foreground text-sm"
					>
						Bookmark
					</button>
					<button class="text-muted-foreground hover:text-foreground text-sm">
						Share
					</button>
				</div>
			</div>
		</div>
	</div>
}

templ RecentDiscoveryCard(session models.ChatSession) {
	<div class="bg-card rounded-xl shadow-sm border hover:shadow-md transition-shadow cursor-pointer">
		<div class="p-6">
			<div class="flex items-start justify-between mb-4">
				<div class="flex items-center gap-3">
					<span class="text-3xl">ğŸ—ºï¸</span>
					<div class="flex flex-col gap-1">
						<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">
							Discovery
						</span>
					</div>
				</div>
			</div>
			<div class="space-y-3">
				<h3 class="font-semibold text-card-foreground group-hover:text-blue-600 transition-colors">
					{ session.CityName }
				</h3>
				<div class="flex items-center gap-2 text-sm text-muted-foreground">
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
					</svg>
					{ session.CreatedAt.Format("Jan 2, 2006") }
				</div>
				if len(session.ConversationHistory) > 0 {
					<p class="text-muted-foreground text-sm line-clamp-2">
						{ session.ConversationHistory[0].Content }
					</p>
				} else {
					<p class="text-muted-foreground text-sm italic">
						No conversation history
					</p>
				}
			</div>
			<div class="flex items-center justify-between mt-4 pt-4 border-t border-border">
				<a
					href={ templ.URL(fmt.Sprintf("/discover/detail/%s", session.ID.String())) }
					class="text-blue-600 hover:text-blue-700 text-sm font-medium"
				>
					View Details
				</a>
				<div class="flex items-center gap-2 text-xs text-muted-foreground">
					<span>{ fmt.Sprintf("%d messages", len(session.ConversationHistory)) }</span>
				</div>
			</div>
		</div>
	</div>
}

templ DiscoverSearchResults(results []DiscoverResult, query, location string) {
	if len(results) == 0 {
		<div class="text-center py-12">
			<svg class="w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
			</svg>
			<p class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">No results found</p>
			<p class="text-sm text-gray-500 dark:text-gray-400">Try a different search query or location</p>
		</div>
	} else {
		<div>
			<h2 class="text-lg font-semibold text-foreground mb-4">
				{ fmt.Sprintf("%d Results for \"%s\" in %s", len(results), query, location) }
			</h2>
			<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
				for _, result := range results {
					@DiscoverResultCard(result)
				}
			</div>
		</div>
	}
}

templ DiscoverResultCard(result DiscoverResult) {
	<div class="bg-card rounded-xl shadow-sm border hover:shadow-md transition-shadow group cursor-pointer">
		<div class="p-6">
			<div class="flex items-start justify-between mb-4">
				<div class="flex items-center gap-3">
					<span class="text-3xl">{ getCategoryEmoji(result.Category) }</span>
					<div class="flex flex-col gap-1">
						<span class={ "inline-flex items-center px-3 py-1 rounded-full text-sm font-medium", getCategoryColor(result.Category) }>
							{ result.Category }
						</span>
						<div class="flex items-center gap-1">
							<svg class="w-4 h-4 text-yellow-500 fill-current" fill="currentColor" viewBox="0 0 24 24">
								<path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
							</svg>
							<span class="text-sm font-medium">{ fmt.Sprintf("%.1f", result.Rating) }</span>
						</div>
					</div>
				</div>
				<button
					hx-post={ "/favorites/add/" + result.ID + "?isLLM=true" }
					hx-target="this"
					hx-swap="outerHTML"
					class="p-2 text-muted-foreground hover:text-red-500 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
					title="Add to favorites"
				>
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
					</svg>
				</button>
			</div>
			<div class="space-y-3">
				<h3 class="font-semibold text-card-foreground group-hover:text-blue-600 transition-colors text-lg">{ result.Name }</h3>
				<div class="flex items-center gap-2 text-sm text-muted-foreground">
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
					</svg>
					{ result.Address }
				</div>
				<p class="text-muted-foreground text-sm line-clamp-3">{ result.Description }</p>
				if len(result.Tags) > 0 {
					<div class="flex flex-wrap gap-1">
						for _, tag := range result.Tags {
							<span class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full">{ tag }</span>
						}
					</div>
				}
			</div>
			<div class="flex items-center justify-between mt-4 pt-4 border-t border-border">
				<div class="flex items-center gap-2 text-sm">
					if result.PriceLevel != "" {
						<span class="font-medium text-green-600 dark:text-green-400">{ result.PriceLevel }</span>
					}
				</div>
				<div class="flex items-center gap-2">
					if result.Website != nil && *result.Website != "" {
						<a href={ templ.URL(*result.Website) } target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-700 dark:text-blue-400 text-sm">
							Website
						</a>
					}
					if result.PhoneNumber != nil && *result.PhoneNumber != "" {
						<a href={ templ.URL("tel:" + *result.PhoneNumber) } class="text-blue-600 hover:text-blue-700 dark:text-blue-400 text-sm">
							Call
						</a>
					}
				</div>
			</div>
		</div>
	</div>
}

func getCategoryEmoji(category string) string {
	categoryLower := strings.ToLower(category)
	emojiMap := map[string]string{
		"restaurant":    "ğŸ½ï¸",
		"hotel":         "ğŸ¨",
		"activity":      "ğŸ¯",
		"attraction":    "ğŸ›ï¸",
		"museum":        "ğŸ¨",
		"park":          "ğŸŒ³",
		"beach":         "ğŸ–ï¸",
		"nightlife":     "ğŸŒƒ",
		"shopping":      "ğŸ›ï¸",
		"cultural":      "ğŸ­",
		"market":        "ğŸª",
		"adventure":     "â›°ï¸",
		"cafe":          "â˜•",
		"bar":           "ğŸº",
		"entertainment": "ğŸª",
	}
	if emoji, ok := emojiMap[categoryLower]; ok {
		return emoji
	}
	return "ğŸ“"
}

func getCategoryColor(category string) string {
	categoryLower := strings.ToLower(category)
	colorMap := map[string]string{
		"restaurant": "bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300",
		"hotel":      "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",
		"activity":   "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",
		"attraction": "bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300",
		"museum":     "bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-300",
		"park":       "bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300",
		"beach":      "bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-300",
		"nightlife":  "bg-violet-100 text-violet-800 dark:bg-violet-900/30 dark:text-violet-300",
	}
	if color, ok := colorMap[categoryLower]; ok {
		return color
	}
	return "bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-300"
}
