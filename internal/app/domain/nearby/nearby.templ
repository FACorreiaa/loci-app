package nearby

templ NearbyPage() {
	<div
		class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900"
		x-data="nearbyApp()"
		x-init="init()"
	>
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8 pb-16">
			<!-- Header -->
			<div class="mb-8">
				<div class="flex items-center justify-between mb-6">
					<div class="flex items-center gap-3">
						<div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
							<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
							</svg>
						</div>
						<div>
							<h1 class="text-2xl font-bold text-foreground">Nearby Places</h1>
							<p class="text-muted-foreground">Discover amazing places as you move</p>
						</div>
					</div>
					<!-- Connection Status -->
					<div class="flex items-center gap-2">
						<div
							class="flex items-center gap-2 px-3 py-2 rounded-lg border"
							:class="wsConnected ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800' : 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800'"
						>
							<div
								class="w-2 h-2 rounded-full"
								:class="wsConnected ? 'bg-green-500 animate-pulse' : 'bg-red-500'"
							></div>
							<span class="text-sm font-medium" :class="wsConnected ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'" x-text="wsConnected ? 'Live' : 'Offline'"></span>
						</div>
					</div>
				</div>
			</div>

			<!-- Controls -->
			<div class="bg-card rounded-xl shadow-lg border p-6 mb-8">
				<div class="flex flex-col md:flex-row gap-4 mb-4">
					<!-- Live Tracking Toggle -->
					<div class="flex items-center gap-3 flex-1">
						<button
							@click="toggleTracking"
							:class="isTracking ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'"
							class="px-6 py-3 text-white rounded-lg transition-all font-medium shadow-md flex items-center gap-2"
						>
							<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
							</svg>
							<span x-text="isTracking ? 'Stop Tracking' : 'Start Live Tracking'"></span>
						</button>
						<div x-show="isTracking" class="text-sm text-muted-foreground">
							<span class="inline-block w-2 h-2 bg-green-500 rounded-full animate-pulse mr-2"></span>
							Tracking your location...
						</div>
					</div>

					<!-- Distance Radius -->
					<div class="flex-1">
						<label class="block text-sm font-medium text-muted-foreground mb-2">Search Radius</label>
						<select
							x-model="radius"
							@change="refreshPOIs"
							class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-background text-foreground"
						>
							<option value="0.5">500m</option>
							<option value="1">1 km</option>
							<option value="2">2 km</option>
							<option value="5" selected>5 km</option>
							<option value="10">10 km</option>
							<option value="25">25 km</option>
							<option value="50">50 km</option>
						</select>
					</div>
				</div>

				<!-- Current Location Display -->
				<div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
					<div>
						<span class="text-sm text-muted-foreground">Latitude:</span>
						<span class="ml-2 font-mono text-sm" x-text="currentLat.toFixed(6)"></span>
					</div>
					<div>
						<span class="text-sm text-muted-foreground">Longitude:</span>
						<span class="ml-2 font-mono text-sm" x-text="currentLon.toFixed(6)"></span>
					</div>
				</div>

				<p class="text-xs text-muted-foreground mt-3">
					ðŸ’¡ Click "Start Live Tracking" to automatically discover places as you move. We'll update results when you move more than 50 meters.
				</p>
			</div>

			<!-- POI Results -->
			<div id="nearby-results">
				<div x-show="loading" class="text-center py-12">
					<div class="w-16 h-16 mx-auto mb-4 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div>
					<p class="text-lg font-medium text-gray-700 dark:text-gray-300">Finding nearby places...</p>
				</div>

				<div x-show="!loading && pois.length === 0 && !isTracking" class="text-center py-12 text-muted-foreground">
					<svg class="w-16 h-16 mx-auto mb-4 text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
					</svg>
					<p class="text-lg font-medium mb-2">Start discovering nearby places</p>
					<p class="text-sm">Click "Start Live Tracking" to begin</p>
				</div>

				<div x-show="!loading && pois.length > 0">
					<h2 class="text-lg font-semibold text-foreground mb-4" x-text="`${pois.length} Places Nearby`"></h2>
					<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
						<template x-for="poi in pois" :key="poi.id">
							<div class="bg-card rounded-xl shadow-sm border hover:shadow-md transition-shadow">
								<div class="p-6">
									<div class="flex items-start justify-between mb-4">
										<div class="flex items-center gap-3">
											<span class="text-3xl" x-text="poi.emoji"></span>
											<div class="flex flex-col gap-1">
												<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300" x-text="poi.category"></span>
												<div class="flex items-center gap-1">
													<svg class="w-4 h-4 text-yellow-500 fill-current" fill="currentColor" viewBox="0 0 24 24">
														<path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
													</svg>
													<span class="text-sm font-medium" x-text="poi.rating.toFixed(1)"></span>
												</div>
											</div>
										</div>
										<button
											:hx-post="`/favorites/add/${poi.id}`"
											hx-target="this"
											hx-swap="outerHTML"
											class="p-2 text-muted-foreground hover:text-red-500 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-all duration-200"
											title="Add to favorites"
										>
											<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
											</svg>
										</button>
									</div>
									<div class="space-y-3">
										<h3 class="font-semibold text-card-foreground text-lg" x-text="poi.name"></h3>
										<div class="flex items-center gap-2 text-sm text-muted-foreground">
											<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
											</svg>
											<span x-text="`${poi.distance.toFixed(2)} km away`"></span>
										</div>
										<p class="text-muted-foreground text-sm line-clamp-2" x-text="poi.description"></p>
									</div>
								</div>
							</div>
						</template>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
	function nearbyApp() {
		return {
			ws: null,
			wsConnected: false,
			isTracking: false,
			currentLat: 38.7223, // Default Lisbon
			currentLon: -9.1393,
			lastLat: 0,
			lastLon: 0,
			radius: 5,
			pois: [],
			loading: false,
			watchId: null,
			reconnectAttempts: 0,
			maxReconnectAttempts: 5,

			init() {
				this.connectWebSocket();
			},

			connectWebSocket() {
				const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';

				// Get JWT token from localStorage if available
				const token = localStorage.getItem('jwt_token');

				// Build WebSocket URL with optional token
				let wsUrl = `${protocol}//${window.location.host}/ws/nearby`;
				if (token) {
					wsUrl += `?token=${token}`;
					console.log('ðŸ“± Connecting to WebSocket with authentication');
				} else {
					console.log('ðŸŒ Connecting to WebSocket as anonymous user');
				}

				try {
					this.ws = new WebSocket(wsUrl);

					this.ws.onopen = () => {
						console.log('WebSocket connected');
						this.wsConnected = true;
						this.reconnectAttempts = 0;
					};

					this.ws.onmessage = (event) => {
						try {
							const data = JSON.parse(event.data);
							if (data.type === 'pois') {
								this.pois = data.pois || [];
								this.loading = false;
							} else if (data.type === 'error') {
								console.error('Server error:', data.message);
								this.loading = false;
							}
						} catch (e) {
							console.error('Failed to parse message:', e);
						}
					};

					this.ws.onerror = (error) => {
						console.error('WebSocket error:', error);
						this.wsConnected = false;
					};

					this.ws.onclose = () => {
						console.log('WebSocket disconnected');
						this.wsConnected = false;

						// Attempt to reconnect
						if (this.reconnectAttempts < this.maxReconnectAttempts) {
							this.reconnectAttempts++;
							const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);
							console.log(`Reconnecting in ${delay}ms... (attempt ${this.reconnectAttempts})`);
							setTimeout(() => this.connectWebSocket(), delay);
						}
					};
				} catch (e) {
					console.error('Failed to create WebSocket:', e);
				}
			},

			toggleTracking() {
				if (this.isTracking) {
					this.stopTracking();
				} else {
					this.startTracking();
				}
			},

			startTracking() {
				if (!navigator.geolocation) {
					alert('Geolocation is not supported by your browser');
					return;
				}

				this.isTracking = true;
				this.loading = true;

				// Get initial position
				navigator.geolocation.getCurrentPosition(
					(position) => {
						this.currentLat = position.coords.latitude;
						this.currentLon = position.coords.longitude;
						this.lastLat = this.currentLat;
						this.lastLon = this.currentLon;
						this.sendLocationUpdate();
					},
					(error) => {
						console.error('Geolocation error:', error);
						alert('Unable to get your location. Please check your permissions.');
						this.isTracking = false;
						this.loading = false;
					}
				);

				// Watch for position changes
				this.watchId = navigator.geolocation.watchPosition(
					(position) => {
						const newLat = position.coords.latitude;
						const newLon = position.coords.longitude;

						// Only update if moved more than ~50 meters
						const distance = this.calculateDistance(this.lastLat, this.lastLon, newLat, newLon);
						if (distance > 0.05) { // 50 meters
							this.currentLat = newLat;
							this.currentLon = newLon;
							this.lastLat = newLat;
							this.lastLon = newLon;
							this.sendLocationUpdate();
						}
					},
					(error) => {
						console.error('Watch position error:', error);
					},
					{
						enableHighAccuracy: true,
						maximumAge: 5000,
						timeout: 10000
					}
				);
			},

			stopTracking() {
				if (this.watchId) {
					navigator.geolocation.clearWatch(this.watchId);
					this.watchId = null;
				}
				this.isTracking = false;
			},

			sendLocationUpdate() {
				if (this.ws && this.ws.readyState === WebSocket.OPEN) {
					this.loading = true;
					this.ws.send(JSON.stringify({
						latitude: this.currentLat,
						longitude: this.currentLon,
						radius: this.radius
					}));
				}
			},

			refreshPOIs() {
				if (this.isTracking) {
					this.sendLocationUpdate();
				}
			},

			calculateDistance(lat1, lon1, lat2, lon2) {
				const R = 6371; // Earth's radius in km
				const dLat = (lat2 - lat1) * Math.PI / 180;
				const dLon = (lon2 - lon1) * Math.PI / 180;
				const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
						Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
						Math.sin(dLon/2) * Math.sin(dLon/2);
				const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
				return R * c;
			}
		}
	}
	</script>
}
